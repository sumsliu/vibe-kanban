# docker-compose.override.yml
# Auto-generated by smart-build.sh v5.4.4
# Purpose: Multi-layer caching for faster rebuilds

version: '3.8'

services:
  vibe-kanban:
    build:
      args:
        # Best mirrors from speed test
        APT_MIRROR: "mirrors.aliyun.com"
        RUSTUP_DIST_SERVER: "https://mirrors.tuna.tsinghua.edu.cn/rustup"

        # v5.4.4: APT 并行下载 (10 并发连接，提升 2-3 倍速度)
        APT_PARALLEL: "10"

        # Clash proxy (if available)
        HTTP_PROXY: "http://host.docker.internal:7897"
        HTTPS_PROXY: "http://host.docker.internal:7897"

      # Layer caching
      cache_from:
        - writing-vibe-kanban:latest
        - writing-vibe-kanban:cache

    # Mount host cache directories
    volumes:
      # Persistent caches (survive container recreation)
      - /Users/liuzf/.cache/vibe-kanban-build/rust:/root/.rustup:cached
      - /Users/liuzf/.cache/vibe-kanban-build/cargo:/root/.cargo:cached
      - /Users/liuzf/.cache/vibe-kanban-build/conda:/opt/conda/pkgs:cached
      - /Users/liuzf/.cache/vibe-kanban-build/npm:/root/.npm:cached

      # Keep existing mounts
      - /Users/liuzf/writing:/writing:cached
      - /Users/liuzf/writing/opensource/vibe-kanban:/repos:cached
